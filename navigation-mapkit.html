<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Navigation</title>
    
    <!-- MapKit JS -->
    <script src="https://cdn.apple-mapkitjs.com/mk/5.x.x/mapkit.js" crossorigin></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Gothic+A1:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Gothic A1', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fafafa;
        }
        #map { height: 100vh; width: 100%; }
        
        #start-nav-button {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 1000;
            background: #046307ff;
            color: #fafafa;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Gothic A1', sans-serif;
            text-align: center;
            box-shadow: 0 4px 20px rgba(4, 99, 7, 0.3);
        }
        #start-nav-button:hover { 
            background: #035206;
            transform: translateY(-1px);
            box-shadow: 0 6px 25px rgba(4, 99, 7, 0.4);
        }
        #start-nav-button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }

        #navigation-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #100c08;
            color: #fafafa;
            max-height: 100px;
            overflow: hidden;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            transition: max-height 0.3s ease-in-out;
            cursor: pointer;
        }
        
        #navigation-panel.expanded {
            max-height: 400px;
            cursor: default;
        }

        #current-nav-content {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #direction-icon {
            width: 44px;
            height: 44px;
            background: transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #direction-icon svg {
            width: 32px;
            height: 32px;
            stroke: #fafafa;
            stroke-width: 2;
            fill: none;
        }

        #instruction-content {
            flex: 1;
            min-width: 0;
        }

        #distance-large {
            font-size: 28px;
            font-weight: 800;
            color: #fafafa;
            line-height: 1.1;
            margin-bottom: 2px;
        }

        #street-name {
            font-size: 18px;
            font-weight: 600;
            color: #999;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #all-directions {
            padding: 0 20px 20px 20px;
            max-height: 320px;
            overflow-y: auto;
            background: #100c08;
        }

        .direction-step {
            padding: 12px 0;
            border-bottom: 1px solid rgba(250, 250, 250, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .direction-step.current {
            background: rgba(15, 82, 186, 0.2);
            margin: 0 -20px;
            padding: 12px 20px;
            border-radius: 8px;
        }

        .step-icon svg {
            width: 24px;
            height: 24px;
            stroke: #fafafa;
            stroke-width: 2;
            fill: none;
        }

        .step-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            color: #fafafa;
        }

        .step-distance {
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }

        #bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #FAFAFA;
            color: #100c08;
            padding: 16px 20px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #arrival-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #arrival-time {
            font-size: 16px;
            font-weight: 700;
            color: #100c08;
        }

        #remaining-stats {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        #end-nav-button {
            background: #046307ff;
            color: #fafafa;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Gothic A1', sans-serif;
        }

        #end-nav-button:hover {
            background: #035206;
        }

        .expand-indicator {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 4px;
            background: rgba(250, 250, 250, 0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <button id="start-nav-button" onclick="forceCreateRoute()">Start Navigation</button>
    <div id="map"></div>

    <script>
        let map;
        let userLocation = null;
        let isNavigating = false;
        let currentRoute = null;
        let currentStepIndex = 0;
        let userAnnotation = null;
        let destinationAnnotation = null;
        let routeSteps = [];
        let routePolyline = null;
        
        const MAPKIT_TOKEN = 'eyJraWQiOiJWUktGUVFHNzZQIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiI4N05MV1VQUVFBIiwiaWF0IjoxNzY3NjYzODM1LCJvcmlnaW4iOiJhcmNoZ3VpZGUuY28ifQ.LL5xZjBhlm-S-IjSUCMOnSMqOeuK_p6NjnTOcvotU-1en9YSjP3JAWuW2xRwMZIafrZr5CSRtmWxg-PUKzVQ4g';
        
        const destination = { name: "Hollywood Sign", lat: 34.1341, lng: -118.3215 };

        // Initialize MapKit
        mapkit.init({
            authorizationCallback: function(done) {
                done(MAPKIT_TOKEN);
            }
        });

        // Get user location
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get('lat'));
        const lng = parseFloat(urlParams.get('lng'));
        
        if (!isNaN(lat) && !isNaN(lng)) {
            userLocation = new mapkit.Coordinate(lat, lng);
        } else {
            userLocation = new mapkit.Coordinate(34.0522, -118.2437);
        }

        // Create map with Apple's default styling
        map = new mapkit.Map("map", {
            center: userLocation,
            showsUserLocation: true,
            tracksUserLocation: false
        });

        // Add user marker
        userAnnotation = new mapkit.MarkerAnnotation(userLocation, {
            color: "#0f52ba",
            glyphText: ""
        });
        map.addAnnotation(userAnnotation);

        // Add destination marker  
        destinationAnnotation = new mapkit.MarkerAnnotation(
            new mapkit.Coordinate(destination.lat, destination.lng),
            {
                color: "#EA4335",
                title: destination.name
            }
        );
        map.addAnnotation(destinationAnnotation);

        // Start location tracking
        startLocationTracking();

        function startLocationTracking() {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.watchPosition(
                (position) => {
                    const newLocation = new mapkit.Coordinate(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    
                    if (position.coords.accuracy > 25) return;
                    
                    userLocation = newLocation;
                    userAnnotation.coordinate = userLocation;
                    
                    if (isNavigating) {
                        map.setCenterAnimated(userLocation, true);
                        checkNavigationProgress();
                        updateDistanceCountdown();
                    }
                },
                (error) => console.log("Location error:", error.message),
                { 
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 1000
                }
            );
        }

        function forceCreateRoute() {
            const button = document.getElementById('start-nav-button');
            button.textContent = "Creating route...";
            button.disabled = true;
            
            // Use MapKit Directions
            const directions = new mapkit.Directions();
            
            const request = {
                origin: userLocation,
                destination: new mapkit.Coordinate(destination.lat, destination.lng),
                transportType: mapkit.Directions.Transport.Automobile
            };
            
            directions.route(request, (error, data) => {
                if (error) {
                    console.error("Directions error:", error);
                    createSimpleRoute();
                } else {
                    currentRoute = data.routes[0];
                    routeSteps = currentRoute.steps;
                    drawRoute(currentRoute);
                }
                
                button.textContent = "Start Navigation";
                button.disabled = false;
                button.onclick = startNavigation;
            });
        }

        function createSimpleRoute() {
            // Fallback: create simple straight line
            routeSteps = [{
                instructions: `Follow the route to ${destination.name}`,
                distance: calculateDistance(userLocation.latitude, userLocation.longitude, destination.lat, destination.lng) * 1000,
                path: [userLocation, new mapkit.Coordinate(destination.lat, destination.lng)]
            }];
            
            drawSimpleRoute();
        }

        function drawRoute(route) {
            if (routePolyline) {
                map.removeOverlay(routePolyline);
            }
            
            routePolyline = new mapkit.PolylineOverlay(route.polyline.points, {
                style: new mapkit.Style({
                    lineWidth: 6,
                    strokeColor: "#0f52ba",
                    strokeOpacity: 0.9
                })
            });
            
            map.addOverlay(routePolyline);
        }

        function drawSimpleRoute() {
            if (routePolyline) {
                map.removeOverlay(routePolyline);
            }
            
            const points = [
                userLocation,
                new mapkit.Coordinate(destination.lat, destination.lng)
            ];
            
            routePolyline = new mapkit.PolylineOverlay(points, {
                style: new mapkit.Style({
                    lineWidth: 6,
                    strokeColor: "#0f52ba",
                    strokeOpacity: 0.9
                })
            });
            
            map.addOverlay(routePolyline);
        }

        function startNavigation() {
            isNavigating = true;
            currentStepIndex = 0;
            
            document.getElementById('start-nav-button').style.display = 'none';
            
            createNavigationPanel();
            createBottomBar();
            
            map.setCenterAnimated(userLocation, true);
            map.region = new mapkit.CoordinateRegion(
                userLocation,
                new mapkit.CoordinateSpan(0.01, 0.01)
            );
            
            updateNavigationPanel();
            updateBottomBar();
        }

        function createNavigationPanel() {
            const navPanel = document.createElement('div');
            navPanel.id = 'navigation-panel';
            navPanel.onclick = toggleDirectionsPanel;
            navPanel.innerHTML = `
                <div id="current-nav-content">
                    <div id="direction-icon">
                        <svg viewBox="0 0 24 24">
                            <polyline points="18,15 12,9 6,15"/><line x1="12" y1="9" x2="12" y2="21"/>
                        </svg>
                    </div>
                    <div id="instruction-content">
                        <div id="distance-large"></div>
                        <div id="street-name"></div>
                    </div>
                </div>
                <div id="all-directions"></div>
                <div class="expand-indicator"></div>
            `;
            document.body.appendChild(navPanel);
        }

        function createBottomBar() {
            const bottomBar = document.createElement('div');
            bottomBar.id = 'bottom-bar';
            bottomBar.innerHTML = `
                <div id="arrival-info">
                    <div id="arrival-time"></div>
                    <div id="remaining-stats"></div>
                </div>
                <button id="end-nav-button" onclick="stopNavigation()">End Route</button>
            `;
            document.body.appendChild(bottomBar);
        }

        function toggleDirectionsPanel() {
            const panel = document.getElementById('navigation-panel');
            const isExpanded = panel.classList.contains('expanded');
            
            if (isExpanded) {
                panel.classList.remove('expanded');
            } else {
                panel.classList.add('expanded');
                updateAllDirections();
            }
        }

        function updateNavigationPanel() {
            if (!isNavigating || !routeSteps.length) return;
            if (currentStepIndex >= routeSteps.length) {
                showArrivalMessage();
                return;
            }
            
            const currentStep = routeSteps[currentStepIndex];
            updateDistanceCountdown();
            
            const instruction = currentStep.instructions || currentStep.notice || "Continue";
            const streetName = extractCleanStreetName(instruction);
            
            document.getElementById('street-name').textContent = streetName;
            updateDirectionIcon(instruction);
        }

        function extractCleanStreetName(instruction) {
            let streetName = instruction
                .replace(/^Continue on /i, '')
                .replace(/^Turn left on /i, '')
                .replace(/^Turn right on /i, '')
                .replace(/^Head /i, '')
                .trim();
            
            return streetName || instruction;
        }

        function updateDirectionIcon(instruction) {
            const svg = document.querySelector('#direction-icon svg');
            let iconPath = '';
            
            if (instruction.toLowerCase().includes('left')) {
                iconPath = '<polyline points="15,6 9,12 15,18"/><line x1="9" y1="12" x2="21" y2="12"/>';
            } else if (instruction.toLowerCase().includes('right')) {
                iconPath = '<polyline points="9,18 15,12 9,6"/><line x1="15" y1="12" x2="3" y2="12"/>';
            } else {
                iconPath = '<polyline points="18,15 12,9 6,15"/><line x1="12" y1="9" x2="12" y2="21"/>';
            }
            
            svg.innerHTML = iconPath;
        }

        function updateAllDirections() {
            const container = document.getElementById('all-directions');
            if (!container || !routeSteps.length) return;
            
            container.innerHTML = '';
            
            routeSteps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = `direction-step ${index === currentStepIndex ? 'current' : ''}`;
                
                const instruction = step.instructions || step.notice || "Continue";
                const cleanStreetName = extractCleanStreetName(instruction);
                const iconPath = getDirectionIcon(instruction);
                
                stepDiv.innerHTML = `
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24">${iconPath}</svg>
                    </div>
                    <div class="step-text">${cleanStreetName}</div>
                    <div class="step-distance">${formatDistance(step.distance)}</div>
                `;
                
                container.appendChild(stepDiv);
            });
        }

        function getDirectionIcon(instruction) {
            if (instruction.toLowerCase().includes('left')) {
                return '<polyline points="15,6 9,12 15,18"/><line x1="9" y1="12" x2="21" y2="12"/>';
            } else if (instruction.toLowerCase().includes('right')) {
                return '<polyline points="9,18 15,12 9,6"/><line x1="15" y1="12" x2="3" y2="12"/>';
            } else {
                return '<polyline points="18,15 12,9 6,15"/><line x1="12" y1="9" x2="12" y2="21"/>';
            }
        }

        function updateBottomBar() {
            if (!isNavigating || !currentRoute) return;
            
            let remainingDuration = 0;
            let remainingDistance = 0;
            
            for (let i = currentStepIndex; i < routeSteps.length; i++) {
                remainingDuration += routeSteps[i].transportType ? routeSteps[i].expectedTravelTime || 0 : 600;
                remainingDistance += routeSteps[i].distance || 0;
            }
            
            const arrivalTime = new Date(Date.now() + remainingDuration * 1000);
            const timeString = arrivalTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            
            document.getElementById('arrival-time').textContent = `Arrive ${timeString}`;
            
            const remainingMinutes = Math.ceil(remainingDuration / 60);
            const remainingMiles = (remainingDistance * 0.000621371).toFixed(1);
            
            document.getElementById('remaining-stats').textContent = `${remainingMinutes} min â€¢ ${remainingMiles} mi`;
        }

        function updateDistanceCountdown() {
            if (!isNavigating || !routeSteps.length || !userLocation) return;
            if (currentStepIndex >= routeSteps.length) return;
            
            const currentStep = routeSteps[currentStepIndex];
            const stepEndCoord = currentStep.path ? currentStep.path[currentStep.path.length - 1] : null;
            
            if (!stepEndCoord) return;
            
            const distanceToTurn = calculateDistance(
                userLocation.latitude, userLocation.longitude,
                stepEndCoord.latitude, stepEndCoord.longitude
            );
            
            const distanceText = formatDistance(distanceToTurn * 1000);
            document.getElementById('distance-large').textContent = distanceText;
        }

        function formatDistance(meters) {
            const feet = meters * 3.28084;
            
            if (feet < 500) {
                return `${Math.round(feet)} ft`;
            } else {
                const miles = meters * 0.000621371;
                return `${miles.toFixed(1)} mi`;
            }
        }

        function checkNavigationProgress() {
            if (!isNavigating || !routeSteps.length || !userLocation) return;
            if (currentStepIndex >= routeSteps.length) return;
            
            const currentStep = routeSteps[currentStepIndex];
            const stepEndCoord = currentStep.path ? currentStep.path[currentStep.path.length - 1] : null;
            
            if (!stepEndCoord) return;
            
            const distanceToTurn = calculateDistance(
                userLocation.latitude, userLocation.longitude,
                stepEndCoord.latitude, stepEndCoord.longitude
            );
            
            if (distanceToTurn < 0.015) {
                currentStepIndex++;
                updateNavigationPanel();
                updateBottomBar();
                
                if (currentStepIndex >= routeSteps.length) {
                    const destinationDistance = calculateDistance(
                        userLocation.latitude, userLocation.longitude,
                        destination.lat, destination.lng
                    );
                    
                    if (destinationDistance < 0.1) {
                        setTimeout(showArrivalMessage, 500);
                    }
                }
            }
        }

        function showArrivalMessage() {
            document.getElementById('distance-large').textContent = "Arrived";
            document.getElementById('street-name').textContent = `Welcome to ${destination.name}!`;
            document.getElementById('arrival-time').textContent = "Arrived";
            document.getElementById('remaining-stats').textContent = "Journey complete";
        }

        function stopNavigation() {
            isNavigating = false;
            currentStepIndex = 0;
            
            const navPanel = document.getElementById('navigation-panel');
            const bottomBar = document.getElementById('bottom-bar');
            
            if (navPanel) navPanel.remove();
            if (bottomBar) bottomBar.remove();
            
            document.getElementById('start-nav-button').style.display = 'block';
            document.getElementById('start-nav-button').textContent = 'Start Navigation';
            document.getElementById('start-nav-button').onclick = startNavigation;
            
            map.region = new mapkit.CoordinateRegion(
                userLocation,
                new mapkit.CoordinateSpan(0.05, 0.05)
            );
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>
