<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Navigation</title>
    
    <!-- MapKit JS -->
    <script src="https://cdn.apple-mapkitjs.com/mk/5.x.x/mapkit.js" crossorigin></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // --- Configuration ---
        const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zdXptcmZ6emtxZmZocGlsaXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjY5NDAsImV4cCI6MjA4MjM0Mjk0MH0.kGHLaDT2FR9AAnZjP96FgAcSPjCQm6w9ifAqd6cEOoQ';
        const MAPKIT_TOKEN = 'eyJraWQiOiJSN05HVzZZNko3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiI4N05MV1VQUVFBIiwiaWF0IjoxNzY3NjcxMDk2LCJvcmlnaW4iOiJhcmNoZ3VpZGUuZ2l0aHViLmlvIn0.aGopUszusE4HfaiqItorz1NoVxzy5z46YItwrq43WVgyERsMm8kkmLZMJNUHd83c-icIhRra2mBFwgpdvYk-SA';
        
        // State
        let map;
        let userLocation = null;
        let isNavigating = false;
        let currentTourId = null;
        let tourStops = [];
        let currentStopIndex = 0;
        let userAnnotation = null;
        let routePolyline = null;
        let stopAnnotations = [];
        let locationWatchId = null;

        // --- MapKit Init ---
        mapkit.init({
            authorizationCallback: function(done) {
                done(MAPKIT_TOKEN);
            }
        });

        // --- Get initial location from URL or use geolocation ---
        function initializeLocation() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));
            
            if (!isNaN(lat) && !isNaN(lng)) {
                userLocation = new mapkit.Coordinate(lat, lng);
                createMap();
            } else {
                // Use device geolocation (more accurate)
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = new mapkit.Coordinate(
                                position.coords.latitude,
                                position.coords.longitude
                            );
                            createMap();
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            // Fallback to LA
                            userLocation = new mapkit.Coordinate(34.0522, -118.2437);
                            createMap();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    // Fallback
                    userLocation = new mapkit.Coordinate(34.0522, -118.2437);
                    createMap();
                }
            }
        }

        // --- Create Map ---
        function createMap() {
            map = new mapkit.Map("map", {
                center: userLocation,
                showsUserLocation: false,
                tracksUserLocation: false
            });

            // Add user marker
            userAnnotation = new mapkit.MarkerAnnotation(userLocation, {
                color: "#007AFF",
                glyphText: "",
                title: "Your Location"
            });
            map.addAnnotation(userAnnotation);
            
            console.log('Map initialized');
            sendMessageToDraftbit({ action: 'mapReady' });
        }

        // --- Load Tour Stops from Supabase ---
        async function loadTourStops(tourId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/stops?tour_id=eq.${tourId}&select=id,stop_index,latitude,longitude,building_id&order=stop_index.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                const stops = await response.json();
                console.log(`Loaded ${stops.length} stops for tour ${tourId}`);
                return stops;
                
            } catch (error) {
                console.error('Error loading tour stops:', error);
                return [];
            }
        }

        // --- Start Navigation ---
        async function startNavigation(tourId) {
            if (isNavigating) {
                console.log('Navigation already in progress');
                return;
            }
            
            currentTourId = tourId;
            currentStopIndex = 0;
            
            // Load stops
            tourStops = await loadTourStops(tourId);
            
            if (tourStops.length === 0) {
                console.error('No stops found for tour');
                sendMessageToDraftbit({ 
                    action: 'navigationError', 
                    error: 'No stops found' 
                });
                return;
            }
            
            isNavigating = true;
            
            // Add stop markers
            addStopMarkers();
            
            // Draw route
            drawRoute();
            
            // Start location tracking
            startLocationTracking();
            
            // Zoom to show route
            fitRouteInView();
            
            // Send navigation started
            sendMessageToDraftbit({ 
                action: 'navigationStarted',
                totalStops: tourStops.length,
                currentStop: currentStopIndex + 1
            });
            
            console.log('Navigation started');
        }

        // --- Add Stop Markers ---
        function addStopMarkers() {
            tourStops.forEach((stop, index) => {
                const annotation = new mapkit.MarkerAnnotation(
                    new mapkit.Coordinate(stop.latitude, stop.longitude),
                    {
                        color: "#EA4335",
                        glyphText: `${index + 1}`,
                        title: `Stop ${index + 1}`
                    }
                );
                map.addAnnotation(annotation);
                stopAnnotations.push(annotation);
            });
        }

        // --- Draw Route ---
        function drawRoute() {
            const coordinates = tourStops.map(stop => 
                new mapkit.Coordinate(stop.latitude, stop.longitude)
            );
            
            if (routePolyline) {
                map.removeOverlay(routePolyline);
            }
            
            routePolyline = new mapkit.PolylineOverlay(coordinates, {
                style: new mapkit.Style({
                    lineWidth: 6,
                    strokeColor: "#007AFF",
                    strokeOpacity: 0.8
                })
            });
            
            map.addOverlay(routePolyline);
        }

        // --- Fit Route in View ---
        function fitRouteInView() {
            if (tourStops.length === 0) return;
            
            const coordinates = tourStops.map(stop => 
                new mapkit.Coordinate(stop.latitude, stop.longitude)
            );
            
            const region = mapkit.BoundingRegion.fromCoordinates(coordinates);
            map.setRegionAnimated(region.toCoordinateRegion(), true);
        }

        // --- Start Location Tracking ---
        function startLocationTracking() {
            if (!navigator.geolocation) return;
            
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const newLocation = new mapkit.Coordinate(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    
                    // Filter for accuracy
                    if (position.coords.accuracy > 25) return;
                    
                    userLocation = newLocation;
                    userAnnotation.coordinate = userLocation;
                    
                    if (isNavigating) {
                        // Keep user centered
                        map.setCenterAnimated(userLocation, false);
                        
                        // Check progress
                        checkNavigationProgress();
                    }
                },
                (error) => console.error('Location error:', error),
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 1000
                }
            );
        }

        // --- Check Navigation Progress ---
        function checkNavigationProgress() {
            if (!isNavigating || currentStopIndex >= tourStops.length) return;
            
            const currentStop = tourStops[currentStopIndex];
            const stopCoord = new mapkit.Coordinate(currentStop.latitude, currentStop.longitude);
            
            const distance = calculateDistance(
                userLocation.latitude,
                userLocation.longitude,
                stopCoord.latitude,
                stopCoord.longitude
            );
            
            // Send distance update to Draftbit
            sendMessageToDraftbit({
                action: 'distanceUpdate',
                distanceToStop: distance,
                currentStop: currentStopIndex + 1,
                totalStops: tourStops.length
            });
            
            // Check if arrived at stop (within 30 meters)
            if (distance < 0.03) {
                arriveAtStop();
            }
        }

        // --- Arrive at Stop ---
        function arriveAtStop() {
            const stop = tourStops[currentStopIndex];
            
            // Send arrival notification
            sendMessageToDraftbit({
                action: 'arrivedAtStop',
                stopIndex: currentStopIndex,
                stopId: stop.id,
                buildingId: stop.building_id,
                currentStop: currentStopIndex + 1,
                totalStops: tourStops.length
            });
            
            console.log(`Arrived at stop ${currentStopIndex + 1}`);
            
            // Move to next stop
            currentStopIndex++;
            
            if (currentStopIndex >= tourStops.length) {
                // Tour complete
                completeTour();
            } else {
                // Continue to next stop
                sendMessageToDraftbit({
                    action: 'nextStop',
                    currentStop: currentStopIndex + 1,
                    totalStops: tourStops.length
                });
            }
        }

        // --- Complete Tour ---
        function completeTour() {
            isNavigating = false;
            
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            sendMessageToDraftbit({
                action: 'tourComplete',
                totalStops: tourStops.length
            });
            
            console.log('Tour complete!');
        }

        // --- Stop Navigation ---
        function stopNavigation() {
            isNavigating = false;
            currentStopIndex = 0;
            
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            // Clear stops
            stopAnnotations.forEach(ann => map.removeAnnotation(ann));
            stopAnnotations = [];
            
            // Clear route
            if (routePolyline) {
                map.removeOverlay(routePolyline);
                routePolyline = null;
            }
            
            sendMessageToDraftbit({ action: 'navigationStopped' });
            
            console.log('Navigation stopped');
        }

        // --- Calculate Distance (km) ---
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- Send Message to Draftbit ---
        function sendMessageToDraftbit(data) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(data));
            } else {
                console.log('Message to Draftbit:', data);
            }
        }

        // --- Initialize ---
        initializeLocation();
    </script>
</body>
</html>
